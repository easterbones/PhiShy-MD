let indovinelli = {
    'Ha le lancette ma non punge.': 'orologio',
    'Ha i denti ma non morde.': 'pettine',
    'Cammina sull\'acqua ma non si bagna.': 'ombra',
    'Ha le zampe ma non cammina.': 'tavolo',
    'Ha le pagine ma non è una pianta.': 'libro',
    'Più ne togli, più diventa grande.': 'buco',
    'Non cammina ma corre, non ha bocca ma mormora.': 'fiume',
    'Ha una testa, una coda, ma non ha corpo.': 'moneta',
    'Non si vede ma si sente, cos’è?': 'vento',
    'Ha una chiave ma non apre nessuna porta.': 'pianoforte',
    'Più è caldo, più è fresco.': 'pane',
    'Non ha bocca ma parla, non ha orecchie ma ascolta.': 'telefono',
    'Ha un collo ma non una testa.': 'bottiglia',
    'Ha un occhio ma non vede.': 'ago',
    'Non si muove ma viaggia per il mondo.': 'francobollo',
    'Ha una corona ma non è re.': 'dente',
    'Ha una coda ma non è animale.': 'cometa',
    'Ha una campana ma non suona.': 'fiore',
    'Ha una lingua ma non parla.': 'scarpa',
    'Ha una schiena ma non si sdraia.': 'sedia',
    'Ha una punta ma non punge.': 'matita',
    'Ha una casa ma non ci abita.': 'lumaca',
    'Ha una barba ma non è uomo.': 'mais',
    'Ha una finestra ma non si apre.': 'computer',
    'Ha una ruota ma non gira.': 'formaggio',
    'Ha una piuma ma non vola.': 'penna',
    'Ha una bocca ma non mangia.': 'fiume',
    'Ha una mano ma non prende.': 'orologio',
    'Ha una chioma ma non è persona.': 'albero',
    'Ha una faccia ma non esprime emozioni.': 'moneta',
    'Ha una scala ma non si sale.': 'musica',
    'Ha una stella ma non brilla.': 'mare',
    'Ha una coda lunga ma non è animale.': 'cometa',
    'Ha una pancia ma non mangia.': 'pentola',
    'Ha una bocca larga ma non parla.': 'caverna',
    'Ha una coperta ma non si copre.': 'letto',
    'Ha una porta ma non si apre.': 'orecchio',
    'Ha una chiave ma non gira.': 'violino',
    'Ha una testa calda ma non pensa.': 'fiammifero',
    'Ha una cintura ma non si allaccia.': 'strada',
    'Ha una corona ma non comanda.': 'albero',
    'Ha una pancia piena ma non mangia.': 'orologio',
    'Ha una bocca asciutta ma non beve.': 'forno',
    'Ha una lingua lunga ma non parla.': 'scarpa',
    'Ha una coda corta ma non è animale.': 'pipa',
    'Ha una barba bianca ma non è vecchio.': 'mais',
    'Ha una finestra sul mondo.': 'televisione',
    'Ha una coperta ma non si scalda.': 'letto',
    'Ha una faccia pulita ma non si lava.': 'orologio',
    'Ha una bocca grande ma non mangia.': 'caverna',
    'Ha una chiave d’oro ma non apre nulla.': 'violino',
    'Ha una testa rotonda ma non pensa.': 'chiodo',
    'Ha una schiena curva ma non si stanca.': 'ponte',
    'Ha una corona verde ma non è re.': 'carciofo',
    'Ha una coda di paglia ma non brucia.': 'asino',
    'Ha una casa mobile ma non cammina.': 'lumaca',
    'Ha una bocca di fuoco ma non brucia.': 'vulcano',
    'Ha una lingua tagliente ma non ferisce.': 'rasoio',
    'Ha una faccia d’argento ma non brilla.': 'specchio',
    'Ha una chiave di violino ma non suona.': 'musica',
    'Ha una corona di spine ma non soffre.': 'rosa',
    'Ha una pancia vuota ma non mangia.': 'bottiglia',
    'Ha una coperta di stelle ma non dorme.': 'cielo',
    'Ha una bocca di ferro ma non morde.': 'chiave',
    'Ha una faccia di bronzo ma non arrossisce.': 'statua',
    'Ha una coda di cavallo ma non corre.': 'capelli',
    'Ha una testa di legno ma non pensa.': 'burattino',
    'Ha una schiena dritta ma non cammina.': 'libro',
    'Ha una bocca di rosa ma non profuma.': 'bocca',
    'Ha una chiave inglese ma non parla inglese.': 'attrezzo',
    'Ha una faccia da schiaffi ma non si offende.': 'pagliaccio',
    'Ha una coda di topo ma non è topo.': 'spina',
    'Ha una testa di rapa ma non è verdura.': 'persona stupida',
    'Ha una bocca di lupo ma non morde.': 'grotta',
    'Ha una faccia di luna ma non è in cielo.': 'orologio',
    'Ha una chiave di casa ma non apre la porta.': 'portachiavi',
    'Ha una pancia di vetro ma non si rompe.': 'lampadina',
    'Ha una coperta di lana ma non si scalda.': 'pecora',
    'Ha una faccia di pietra ma non è statua.': 'montagna',
    'Ha una bocca di fuoco ma non brucia.': 'vulcano',
    'Ha una chiave di sol ma non suona.': 'musica',
    'Ha una testa di chiodo ma non punge.': 'martello',
    'Ha una schiena di ferro ma non si piega.': 'ponte',
    'Ha una faccia di carta ma non si strappa.': 'carta d’identità',
    'Ha una coda di pesce ma non nuota.': 'sirena',
    'Ha una bocca di rosa ma non profuma.': 'bocca',
    'Ha una chiave di violino ma non suona.': 'musica',
    'Ha una faccia di bronzo ma non arrossisce.': 'statua',
    'Ha una coda di cavallo ma non corre.': 'capelli',
    'Ha una testa di legno ma non pensa.': 'burattino',
    'Ha una schiena dritta ma non cammina.': 'libro',
    'Ha una bocca di rosa ma non profuma.': 'bocca',
    'Ha una chiave inglese ma non parla inglese.': 'attrezzo',
    'Ha una faccia da schiaffi ma non si offende.': 'pagliaccio',
    'Ha una coda di topo ma non è topo.': 'spina',
    'Ha una testa di rapa ma non è verdura.': 'persona stupida',
    'Ha una bocca di lupo ma non morde.': 'grotta',
    'Ha una faccia di luna ma non è in cielo.': 'orologio',
    'Ha una chiave di casa ma non apre la porta.': 'portachiavi',
    'Ha una pancia di vetro ma non si rompe.': 'lampadina',
    'Ha una coperta di lana ma non si scalda.': 'pecora',
    'Ha una faccia di pietra ma non è statua.': 'montagna',
    'Ha una bocca di fuoco ma non brucia.': 'vulcano',
    'Ha una chiave di sol ma non suona.': 'musica',
    'Ha una testa di chiodo ma non punge.': 'martello',
    'Ha una schiena di ferro ma non si piega.': 'ponte',
    'Ha una faccia di carta ma non si strappa.': 'carta d’identità',
    'Ha una coda di pesce ma non nuota.': 'sirena'
}

let partiteIndovinelli = {}

let handler = async (m, { conn, command, args, usedPrefix }) => {
    let id = m.sender
    const maxTentativi = 3

    if (command === 'indovinello') {
        if (partiteIndovinelli[id]) {
            return conn.reply(m.chat, 'Hai già una partita in corso. Usa *.rispondi <risposta>* per continuare.', m, rcanal)
        }

        let chiavi = Object.keys(indovinelli)
        let domanda = chiavi[Math.floor(Math.random() * chiavi.length)]
        let risposta = indovinelli[domanda]

        partiteIndovinelli[id] = {
            domanda,
            risposta,
            tentativi: maxTentativi,
            terminato: false
        }

        return conn.reply(m.chat, `Indovina questo enigma. *${domanda}* Tentativi totali: *${maxTentativi}.* Rispondi con *.rispondi <risposta>* per iniziare.`, m, rcanal)
    }

    if (command === 'rispondi') {
        if (!partiteIndovinelli[id]) {
            return conn.reply(m.chat, 'Non hai una partita attiva. Usa *.indovinello* per iniziare una nuova.', m, rcanal)
        }

        let partita = partiteIndovinelli[id]
        if (partita.terminato) {
            delete partiteIndovinelli[id]
            return conn.reply(m.chat, 'Questa partita è già terminata. Usa *.indovinello* per giocare di nuovo.', m, rcanal)
        }

        let tentativo = args.join(' ')?.toLowerCase().trim()
        if (!tentativo) return conn.reply(m.chat, 'Scrivi una risposta per provare a *indovinare.*', m, phishy)

        if (tentativo === partita.risposta.toLowerCase()) {
            partita.terminato = true
            return conn.reply(m.chat, `Corretto! La risposta era: *${partita.risposta}*`, m, phishy)
        } else {
            partita.tentativi--
            if (partita.tentativi <= 0) {
                partita.terminato = true
                return conn.reply(m.chat, `Hai perso! La risposta corretta era: *${partita.risposta}*`, m, rcanal)
            } else {
                return conn.reply(m.chat, `Risposta errata. Tentativi rimasti: *${partita.tentativi}.*`, m, rcanal)
            }
        }
    }
}

handler.help = ['indovinello']
handler.tags = ['game']
handler.command = ['indovinello', 'rispondi']

export default handler