import fetch from 'node-fetch';

let handler = async (m, { conn, args, participants }) => {
    const unaSettimanaFa = Date.now() - 7 * 24 * 60 * 60 * 1000;

    let utenti = participants
        .filter(p => p.id !== conn.user.jid)
        .map(p => {
            let user = global.db.data.users[p.id] || {};
            let messaggiRecenti = (user.messaggiSettimanali || []).filter(ts => ts >= unaSettimanaFa);
            return {
                jid: p.id,
                messaggi: messaggiRecenti.length
            };
        });

    let ordinati = utenti.sort((a, b) => b.messaggi - a.messaggi);
    let topUtenti = ordinati.map(u => u.jid);
    let limit = args[0] ? Math.min(100, Math.max(parseInt(args[0]), 10)) : 10;

    if (limit > 100) {
        return conn.reply(m.chat, 'âš ï¸ La classifica puÃ² mostrare al massimo i primi 100 utenti.', m, rcanal);
    }

    let tuaPosizione = topUtenti.indexOf(m.sender) + 1;
    let totaleUtenti = utenti.length;

    let messaggio = `ğŸ“Š ğ“ğ¨ğ© ${limit} ğ®ğ­ğğ§ğ­ğ¢ ğğğ¥ğ¥'ğ®ğ¥ğ­ğ¢ğ¦ğš ğ¬ğğ­ğ­ğ¢ğ¦ğšğ§ğš\n\n` +
        ordinati.slice(0, limit).map(({ jid, messaggi }, i) =>
            getMedaglia(i + 1) + ` Â« *${messaggi}* Â» @${jid.split('@')[0]}`
        ).join('\n');

    if (m.sender !== conn.user.jid) {
        messaggio += `\n\nğŸ¯ ğ“ğ®ğš ğ©ğ¨ğ¬ğ¢ğ³ğ¢ğ¨ğ§ğ: *${tuaPosizione}Â°* su *${totaleUtenti}* partecipanti`;
    }

    let fakeMessage = {
        key: { participants: '0@s.whatsapp.net', fromMe: false, id: 'Halo' },
        message: {
            locationMessage: {
                name: 'ğ‚ğ¥ğšğ¬ğ¬ğ¢ğŸğ¢ğœğš ğŒğğ¬ğ¬ğšğ ğ ğ¢',
                jpegThumbnail: await (await fetch('https://telegra.ph/file/b311b1ffefcc34f681e36.png')).buffer(),
                vcard: 'BEGIN:VCARD\nVERSION:3.0\nN:;TopSettimana;;;\nFN:TopSettimana\nORG:TopSettimana\nTITLE:\nitem1.TEL;waid=111:+111111111\nitem1.X-ABLabel:Settimana\nEND:VCARD'
            }
        },
        participant: '0@s.whatsapp.net'
    };

    conn.reply(m.chat, messaggio.trim(), fakeMessage, { mentions: [...topUtenti.slice(0, limit)] });
};

handler.command = /^(settimana|topsettimana|settimanale|topsettimanale)$/i;
handler.group = true;

export default handler;

function getMedaglia(posizione) {
    if (posizione === 1) return 'ğŸ¥‡';
    if (posizione === 2) return 'ğŸ¥ˆ';
    if (posizione === 3) return 'ğŸ¥‰';
    return 'ğŸ…';
}
