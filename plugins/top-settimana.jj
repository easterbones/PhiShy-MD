import fetch from 'node-fetch';

let handler = async (m, { conn, args, participants }) => {
    const unaSettimanaFa = Date.now() - 7 * 24 * 60 * 60 * 1000;

    let utenti = participants
        .filter(p => p.id !== conn.user.jid)
        .map(p => {
            let user = global.db.data.users[p.id] || {};
            let messaggiRecenti = (user.messaggiSettimanali || []).filter(ts => ts >= unaSettimanaFa);
            return {
                jid: p.id,
                messaggi: messaggiRecenti.length
            };
        });

    let ordinati = utenti.sort((a, b) => b.messaggi - a.messaggi);
    let topUtenti = ordinati.map(u => u.jid);
    let limit = args[0] ? Math.min(100, Math.max(parseInt(args[0]), 10)) : 10;

    if (limit > 100) {
        return conn.reply(m.chat, '⚠️ La classifica può mostrare al massimo i primi 100 utenti.', m, rcanal);
    }

    let tuaPosizione = topUtenti.indexOf(m.sender) + 1;
    let totaleUtenti = utenti.length;

    let messaggio = `📊 𝐓𝐨𝐩 ${limit} 𝐮𝐭𝐞𝐧𝐭𝐢 𝐝𝐞𝐥𝐥'𝐮𝐥𝐭𝐢𝐦𝐚 𝐬𝐞𝐭𝐭𝐢𝐦𝐚𝐧𝐚\n\n` +
        ordinati.slice(0, limit).map(({ jid, messaggi }, i) =>
            getMedaglia(i + 1) + ` « *${messaggi}* » @${jid.split('@')[0]}`
        ).join('\n');

    if (m.sender !== conn.user.jid) {
        messaggio += `\n\n🎯 𝐓𝐮𝐚 𝐩𝐨𝐬𝐢𝐳𝐢𝐨𝐧𝐞: *${tuaPosizione}°* su *${totaleUtenti}* partecipanti`;
    }

    let fakeMessage = {
        key: { participants: '0@s.whatsapp.net', fromMe: false, id: 'Halo' },
        message: {
            locationMessage: {
                name: '𝐂𝐥𝐚𝐬𝐬𝐢𝐟𝐢𝐜𝐚 𝐌𝐞𝐬𝐬𝐚𝐠𝐠𝐢',
                jpegThumbnail: await (await fetch('https://telegra.ph/file/b311b1ffefcc34f681e36.png')).buffer(),
                vcard: 'BEGIN:VCARD\nVERSION:3.0\nN:;TopSettimana;;;\nFN:TopSettimana\nORG:TopSettimana\nTITLE:\nitem1.TEL;waid=111:+111111111\nitem1.X-ABLabel:Settimana\nEND:VCARD'
            }
        },
        participant: '0@s.whatsapp.net'
    };

    conn.reply(m.chat, messaggio.trim(), fakeMessage, { mentions: [...topUtenti.slice(0, limit)] });
};

handler.command = /^(settimana|topsettimana|settimanale|topsettimanale)$/i;
handler.group = true;

export default handler;

function getMedaglia(posizione) {
    if (posizione === 1) return '🥇';
    if (posizione === 2) return '🥈';
    if (posizione === 3) return '🥉';
    return '🏅';
}
