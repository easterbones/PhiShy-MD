import os from 'os';
import util from 'util';
import sizeFormatter from 'human-readable';
import MessageType from '@whiskeysockets/baileys';
import fs from 'fs';
import { performance } from 'perf_hooks';

const handler = async (m, { conn, text, usedPrefix, isAdmin, isOwner }) => {
    
    const groupMetadata = await conn.groupMetadata(m.chat);
    const groupOwner = groupMetadata.owner || m.chat.split('-')[0] + "@s.whatsapp.net";
    const botOwner = global.owner[0] + "@s.whatsapp.net";

        let userToMute = m.mentionedJid[0] ? m.mentionedJid[0] : m.quoted ? m.quoted.sender : text;
        if (userToMute === groupOwner) {
      throw "â“˜ ğˆğ¥ ğœğ«ğğšğ­ğ¨ğ«ğ ğğğ¥ ğ ğ«ğ®ğ©ğ©ğ¨ ğ§ğ¨ğ§ ğ©ğ®ğ¨' ğğ¬ğ¬ğğ«ğ ğ¦ğ®ğ­ğšğ­ğ¨";
    }

    if (userToMute === botOwner) {
      throw "â“˜ ğğ¨ğ§ ğ©ğ®ğ¨ğ¢ ğ¦ğ®ğ­ğšğ«ğ ğ¥'ğ¨ğ°ğ§ğğ« ğğğ¥ ğ›ğ¨ğ­";
    }

    if (userToMute === conn.user.jid) {
      throw "â“˜ ğğ¨ğ§ ğ©ğ®ğ¨ğ¢ ğ¦ğ®ğ­ğšğ«ğ ğ¢ğ¥ ğ›ğ¨ğ­";
    }

  const users = global.db.data.users;
  if (!users[m.sender]) users[m.sender] = {};
  if (typeof users[m.sender].joincount !== 'number') users[m.sender].joincount = 0;

  const user = users[m.sender];
    

  if (!text || !text.includes('@')) {
    return m.reply('âš ï¸ Formato del comando non valido! Utilizzo corretto: mutetime <durata> @user *(durata in m/h)*');
  }

  let durationText = 'â›” Durata non valida, specifica un tempo tra *1m* e *24h*';
  let duration = 0;
  const menzione = m.mentionedJid[0] || '';

  if (!menzione) {
    return m.reply('Non hai menzionato la vittima da mutare');
  }

  const timeInput = text.split(' ')[0].toLowerCase();
  if (timeInput.endsWith('m')) {
    duration = parseInt(timeInput) * 60 * 1000;
    const minuteText = parseInt(timeInput) === 1 ? 'minuto' : 'minuti';
    durationText = `ğŸ”‡ *@${menzione.split`@`[0]}* starÃ  zitto/a per *${parseInt(timeInput)}* ${minuteText}. Meno male, aveva rotto il cazzo ğŸ˜®â€ğŸ’¨`;
  } else if (timeInput.endsWith('h')) {
    duration = parseInt(timeInput) * 60 * 60 * 1000;
    const hourText = parseInt(timeInput) === 1 ? 'ora' : 'fottute ore';
    durationText = `ğŸ”‡ *@${menzione.split`@`[0]}* starÃ  zitto/a per *${parseInt(timeInput)}* ${hourText}. Aveva proprio scassato i coglioni eh ğŸ™„`;
  }

  if (duration >= 60000 && duration <= 86400000) {
    if (!isAdmin && !isOwner) {
      if (user.joincount < 1) {
        return m.reply('âŒ Non hai permessi per usare questo comando. Ottieni un joincount per poterlo usare.');
      }
      if (duration > 15 * 60 * 1000) {
        return m.reply('â›” Puoi mutare un utente per massimo 15 minuti con un joincount!');
      }
      user.joincount -= 1;
    }

    if (!users[menzione]) {
      users[menzione] = {};
    }
    users[menzione].muto = true;

    m.reply(durationText);

    setTimeout(() => {
      if (users[menzione] && users[menzione].muto) {
        users[menzione].muto = false;
        delete users[menzione].muteEndTime;
        m.reply(`ğŸ”Š La punizione di *@${menzione.split`@`[0]}* Ã¨ purtroppo finita. Adesso ricomincerÃ  a rompere il cazzo...`);
      }
    }, duration);
  } else {
    m.reply(durationText);
  }
};

handler.command = /^mutetime|setmuta|timermuta$/i;
handler.admin = false;
export default handler;
